apiVersion: batch/v1
kind: CronJob
metadata:
  name: etl-load
spec:
  schedule: "0 0 1 1 *" # runs once per year on Jan 1st
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: pgloader
            image: dimitri/pgloader:v3.6.7           
            command: [ "/bin/sh", "-c" ]
            args:
              - |
                echo "[INFO] Cleaning data..."
                iconv -f UTF-16LE -t UTF-8 /data/etl/content.tsv | tr -d '\000' | sed '1s/^\xEF\xBB\xBF//' > /data/etl/clean.tsv
                echo "[INFO] Creating script..."
                sed "s|\${URI}|$URI|g" /scripts/content-minimal.tsv.staged.load > /tmp/load-script
                echo "[INFO] Loading data..."
                pgloader /tmp/load-script
            env:
              - name: URI
                valueFrom:
                  secretKeyRef:
                    name: mydb-app
                    key: uri                
            volumeMounts:
              - name: data
                mountPath: /data            
              - name: scripts
                mountPath: /scripts                
          volumes:
          - name: data
            persistentVolumeClaim:
              claimName: smb-test-pvc        
          - name: scripts
            configMap:
              name: etl-pgloader-script