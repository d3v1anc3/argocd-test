apiVersion: batch/v1
kind: CronJob
metadata:
  name: etl-extract
spec:
  schedule: "0 0 1 1 *" # runs once per year on Jan 1st
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: mssql-export
            image: mcr.microsoft.com/mssql-tools
            command: [ "/bin/sh", "-c" ]
            args:
              - |
                echo "[INFO] Exporting data with bcp..."
                export PATH=$PATH:/opt/mssql-tools/bin
                bcp "SELECT Id, FileIdentifier, Title, Artist, DurationInSeconds, ContentType, FileContentType FROM dbo.Content WHERE DurationInSeconds > 0 AND ContentType = 'Xenox' AND FileContentType = 'Audio'" \
                  queryout "/data/etl/content.tsv" -w -t "\t" -r "\n" \
                  -S "$MSSQL_HOST" -U "$MSSQL_USER" -P "$MSSQL_PASS"
            env:
              - name: MSSQL_HOST
                valueFrom:
                  configMapKeyRef:
                    name: etl-config
                    key: portal-database-ip
              - name: MSSQL_USER
                valueFrom:
                  secretKeyRef:
                    name: etl-secret
                    key: portal-database-username
              - name: MSSQL_PASS
                valueFrom:
                  secretKeyRef:
                    name: etl-secret
                    key: portal-database-password
            volumeMounts:
              - name: data
                mountPath: /data                                  
          volumes:
          - name: data
            persistentVolumeClaim:
              claimName: smb-test-pvc
           