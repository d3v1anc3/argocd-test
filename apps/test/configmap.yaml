apiVersion: v1
kind: ConfigMap
metadata:
  name: database-bootstrap-sql
data:
  init.sql: |    
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'test-db') THEN
        EXECUTE 'CREATE DATABASE "test-db"';
      END IF;
    END
    $$;

    
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'etl') THEN
          EXECUTE 'CREATE USER etl WITH PASSWORD ''Password1234$''';
          EXECUTE 'GRANT ALL PRIVILEGES ON DATABASE "test-db" TO etl';
      END IF;
    END
    $$;

    
